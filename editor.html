<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Permissions-Policy" content="unload=(), browsing-topics=(), idle-detection=(), magnetometer=(), accelerometer=(), gyroscope=(), camera=(), microphone=(), geolocation=(), payment=(), interest-cohort=()">
  <title>Web å®æ—¶ç¼–è¯‘å™¨ Â· VSCode é£æ ¼</title>
  <!-- ä½¿ç”¨æœ¬åœ°å­—ä½“æ›¿ä»£æ–¹æ¡ˆ -->
  <style>
    @font-face {
      font-family: 'Inter';
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src: local('Microsoft YaHei'), local('Arial'), sans-serif;
    }
    @font-face {
      font-family: 'JetBrains Mono';
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src: local('Consolas'), local('Courier New'), monospace;
    }
  </style>
  <link rel="stylesheet" href="lib/codemirror/codemirror.min.css" />
  <link rel="stylesheet" href="lib/codemirror/material-darker.min.css" />
  <link rel="stylesheet" href="style/main.css" />
  <!-- å…¨å±€è®¾ç½®ç®¡ç†å™¨ - ç»Ÿä¸€ä¸»é¢˜å’Œè¯­è¨€ -->
  <script src="js/globalSettings.js"></script>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar" aria-label="æ–‡ä»¶åˆ—è¡¨">
      <div class="sidebar-header">
        <span data-i18n="file-explorer">èµ„æºç®¡ç†å™¨</span>
        <button class="import-btn" id="import-btn" title="å¯¼å…¥æ–‡ä»¶">ğŸ“</button>
      </div>
      <div class="workspace">WEB-COMPILER Â· LIVE</div>
      <ul class="file-tree" id="file-tree">
        <!-- æ–‡ä»¶æ ‘å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </ul>
    </aside>

    <!-- èµ„æºç®¡ç†å™¨å’Œç¼–è¾‘åŒºä¹‹é—´çš„åˆ†éš”æ  -->
    <div class="resizer vertical-resizer" id="sidebar-resizer" data-resizer="sidebar"></div>

    <!-- æ–‡ä»¶å¯¼å…¥è¾“å…¥ -->
    <input type="file" id="file-input" multiple accept=".html,.css,.js,.json,.csv,.md,.txt,.png,.jpg,.jpeg,.gif,.svg" style="display: none;">

    <!-- å³é”®ä¸Šä¸‹æ–‡èœå• -->
    <div id="context-menu" class="context-menu" style="display: none;">
      <div class="menu-item" data-action="new-file" data-i18n="create-file">ğŸ“„ æ–°å»ºæ–‡ä»¶</div>
      <div class="menu-item" data-action="new-folder" data-i18n="create-folder">ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹</div>
      <div class="menu-separator"></div>
      <div class="menu-item" data-action="import-file">ğŸ“ å¯¼å…¥æ–‡ä»¶</div>
      <div class="menu-separator"></div>
      <div class="menu-item" data-action="rename">âœï¸ é‡å‘½å</div>
      <div class="menu-item" data-action="delete">ğŸ—‘ï¸ åˆ é™¤</div>
    </div>

    <main class="main-area">
      <header class="command-bar">
        <div class="window-actions">
          <span class="dot dot-red"></span>
          <span class="dot dot-yellow"></span>
          <span class="dot dot-green"></span>
        </div>
        <div class="breadcrumbs"></div>
        <div class="command-actions">
          <!-- ä½œä¸šå¯¼èˆªæŒ‰é’® -->
          <button id="assignment-back-btn" class="template-button" onclick="goBackToAssignment()" data-i18n="back-to-assignment">ğŸ”™ è¿”å›</button>
          <button id="assignment-submit-btn" class="template-button" onclick="submitAssignment()" data-i18n="submit-assignment">ğŸ“‹ æäº¤</button>

          <button id="ai-assistant-btn" class="ai-button" data-i18n="ai-programming">ğŸ¤– AIç¼–ç¨‹</button>
            <button id="export-btn" class="template-button" data-i18n="export-project">ğŸ“¦ å¯¼å‡º</button>
          <button id="template-btn" class="template-button" data-i18n="template-btn">ğŸ“Š æ¨¡æ¿</button>
          <button id="theme-toggle-btn" class="theme-button" data-i18n="theme-dark">ğŸŒ™ æ·±è‰²</button>
          <label class="auto-run-toggle">
            <input type="checkbox" id="auto-run" checked />
            <span data-i18n="auto-run">è‡ªåŠ¨ç¼–è¯‘</span>
          </label>
          <button id="run-btn" class="primary" data-i18n="run-btn">ç«‹å³è¿è¡Œ</button>
        </div>
      </header>

      <div class="tab-row">
        <div id="tab-container" class="tab-container">
          <!-- åŠ¨æ€Tabå°†åœ¨è¿™é‡Œç”Ÿæˆ -->
        </div>
        <div class="tab-spacer"></div>
        <button id="lang-toggle-btn" class="lang-button" title="åˆ‡æ¢è¯­è¨€">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
          </svg>
          <span id="current-lang">ä¸­</span>
        </button>
        <div class="status-text" id="status-text" data-i18n="status-ready">å‡†å¤‡å°±ç»ª</div>
      </div>

      <section class="editor-grid">
        <div class="multi-editor">
          <div class="pane code-pane is-active" data-file="html">
            <div class="pane-header">
              <div>
                <span class="pane-filename">index.html</span> <span class="pane-tag">HTML</span>
              </div>
              <div class="pane-tools">
                <button class="tool format-btn" data-file="html" title="æ ¼å¼åŒ–ä»£ç ">ğŸ“‹</button>
                <button class="tool clear-btn" data-file="html" title="æ¸…ç©ºä»£ç ">ğŸ—‘ï¸</button>
              </div>
            </div>
            <textarea id="html-code" spellcheck="false" aria-label="HTML ç¼–è¾‘å™¨"></textarea>
          </div>
          <div class="pane code-pane" data-file="css">
            <div class="pane-header">
              <div>
                <span class="pane-filename">style.css</span> <span class="pane-tag">CSS</span>
              </div>
              <div class="pane-tools">
                <button class="tool format-btn" data-file="css" title="æ ¼å¼åŒ–ä»£ç ">ğŸ“‹</button>
                <button class="tool clear-btn" data-file="css" title="æ¸…ç©ºä»£ç ">ğŸ—‘ï¸</button>
              </div>
            </div>
            <textarea id="css-code" spellcheck="false" aria-label="CSS ç¼–è¾‘å™¨"></textarea>
          </div>
          <div class="pane code-pane" data-file="js">
            <div class="pane-header">
              <div>
                <span class="pane-filename">main.js</span> <span class="pane-tag">JavaScript</span>
              </div>
              <div class="pane-tools">
                <button class="tool format-btn" data-file="js" title="æ ¼å¼åŒ–ä»£ç ">ğŸ“‹</button>
                <button class="tool clear-btn" data-file="js" title="æ¸…ç©ºä»£ç ">ğŸ—‘ï¸</button>
              </div>
            </div>
            <textarea id="js-code" spellcheck="false" aria-label="JavaScript ç¼–è¾‘å™¨"></textarea>
          </div>
        </div>
        <!-- ç¼–è¾‘åŒºå’Œé¢„è§ˆåŒºä¹‹é—´çš„åˆ†éš”æ  -->
        <div class="resizer vertical-resizer" id="editor-resizer" data-resizer="editor"></div>
        <div class="pane preview-pane">
          <div class="pane-header">
            <div data-i18n="real-time-preview">å®æ—¶é¢„è§ˆ</div>
            <div class="pane-tools">
              <button class="fullscreen-btn" id="fullscreen-btn" title="å…¨å±é¢„è§ˆ">â›¶</button>
              <span class="indicator" id="compile-indicator" data-state="idle">â—</span>
              <span>Live</span>
            </div>
          </div>
          <iframe id="preview" title="è¿è¡Œç»“æœ" sandbox="allow-scripts allow-same-origin" aria-live="polite"></iframe>
        </div>
      </section>

      <section class="panel console-panel" id="console-panel">
        <div class="panel-tabs">
          <button class="panel-tab is-active" data-i18n="debug-console">è°ƒè¯•æ§åˆ¶å°</button>
          <button class="panel-tab" data-i18n="terminal">ç»ˆç«¯</button>
          <button class="panel-tab" data-i18n="issues">é—®é¢˜</button>
          <button id="toggle-console" class="console-toggle-btn" title="éšè—æ§åˆ¶å°" data-i18n-title="hide-console" data-i18n="hide-console">
            <span class="toggle-icon">â–¼</span>
          </button>
        </div>
        <div class="console-tools">
          <div class="filter-group" role="group" aria-label="æ—¥å¿—è¿‡æ»¤">
            <button class="filter-chip is-active" data-level="log" data-i18n="console-level-log">Log</button>
            <button class="filter-chip is-active" data-level="info" data-i18n="console-level-info">Info</button>
            <button class="filter-chip is-active" data-level="warn" data-i18n="console-level-warn">Warn</button>
            <button class="filter-chip is-active" data-level="error" data-i18n="console-level-error">Error</button>
          </div>
          <button id="clear-console" class="clear-btn" data-i18n="console-clear">æ¸…ç©ºæ§åˆ¶å°</button>
        </div>
        <div class="console-content">
          <div class="console-output" id="console-output" aria-live="polite"></div>
        </div>
      </section>

      <!-- æ§åˆ¶å°æ¢å¤æŒ‰é’®ï¼ˆéšè—æ—¶æ˜¾ç¤ºï¼‰ -->
      <button id="restore-console" class="restore-console-btn" title="æ˜¾ç¤ºæ§åˆ¶å°" style="display: none;">
        <span>ğŸ“‹</span>
        <span>æ§åˆ¶å°</span>
      </button>
    </main>
  </div>

  <!-- AIç¼–ç¨‹åŠ©æ‰‹å¯¹è¯æ¡† -->
  <div id="ai-assistant-modal" class="ai-assistant-modal">
    <div class="ai-assistant-content">
      <div class="ai-assistant-header">
        <h3 data-i18n="ai-title">ğŸ¤– AIç¼–ç¨‹åŠ©æ‰‹</h3>
        <button class="close-btn" id="close-ai-assistant">&times;</button>
      </div>
      <div class="ai-assistant-body">
        <div class="input-group">
          <label for="ai-prompt" data-i18n="ai-prompt-label">æè¿°æ‚¨çš„éœ€æ±‚:</label>
          <textarea id="ai-prompt" data-i18n-placeholder="ai-placeholder" placeholder="è¯·ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„ä»£ç æˆ–æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼šåˆ›å»ºä¸€ä¸ªå“åº”å¼çš„å¯¼èˆªæ ç»„ä»¶"></textarea>
        </div>
        <div class="input-group">
          <label for="generation-type">æ–‡ä»¶ç”Ÿæˆæ–¹å¼:</label>
          <select id="generation-type">
            <option value="single-html">ç”Ÿæˆå®Œæ•´HTMLæ–‡ä»¶</option>
            <option value="separated">åˆ†ç¦»HTMLã€CSSã€JSæ–‡ä»¶</option>
          </select>
        </div>
        <div class="input-group">
          <label for="target-folder">ç›®æ ‡æ–‡ä»¶å¤¹:</label>
          <select id="target-folder">
            <option value="auto">è‡ªåŠ¨åˆ†é…</option>
            <option value="html">html/</option>
            <option value="css">css/</option>
            <option value="js">js/</option>
            <option value="data">data/</option>
            <option value="root">æ ¹ç›®å½•</option>
          </select>
        </div>
        <div class="input-group">
          <label>
            <input type="checkbox" id="overwrite-files" />
            è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶
          </label>
        </div>
        <div class="ai-actions">
          <button id="generate-code-btn" class="primary generate-btn">
            <span class="btn-text">ç”Ÿæˆä»£ç </span>
            <span class="btn-loading" style="display: none;">ç”Ÿæˆä¸­...</span>
          </button>
          <button id="confirm-files-btn" class="primary" style="display: none;">ç¡®è®¤å¹¶åˆ›å»ºæ–‡ä»¶</button>
          <button id="cancel-ai-btn" class="secondary">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ä»£ç åº“ä¿å­˜å¯¹è¯æ¡† -->
  <div id="code-repo-modal" class="ai-assistant-modal" style="display: none;">
    <div class="ai-assistant-content">
      <div class="ai-assistant-header">
        <h3>ğŸ’¾ ä¿å­˜åˆ°ä»£ç åº“</h3>
        <button class="close-btn" id="close-code-repo">&times;</button>
      </div>
      <div class="ai-assistant-body">
        <form id="code-repo-form" class="space-y-4">
          <div class="input-group">
            <label for="repo-title">æ¡ˆä¾‹æ ‡é¢˜<span style="color: #f87171;">*</span></label>
            <input id="repo-title" type="text" placeholder="ä¾‹å¦‚ï¼šæ•°ç»„å»é‡æ¡ˆä¾‹" />
          </div>
          <div class="input-group">
            <label for="repo-description">æ¡ˆä¾‹è¯´æ˜</label>
            <textarea id="repo-description" placeholder="ç®€è¦æè¿°æœ¬æ¡ˆä¾‹çš„æ•™å­¦ç›®æ ‡å’Œè¦ç‚¹"></textarea>
          </div>
          <div class="input-group">
            <label for="repo-category">ç±»åˆ«</label>
            <input id="repo-category" type="text" placeholder="ä¾‹å¦‚ï¼šåŸºç¡€è¯­æ³• / DOMæ“ä½œ / å¸ƒå±€" />
          </div>
          <div class="input-group">
            <label for="repo-difficulty">éš¾åº¦</label>
            <select id="repo-difficulty">
              <option value="easy">ç®€å•</option>
              <option value="medium">ä¸­ç­‰</option>
              <option value="hard">å›°éš¾</option>
            </select>
          </div>
          <div class="input-group">
            <label for="repo-tags">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
            <input id="repo-tags" type="text" placeholder="ä¾‹å¦‚ï¼šJavaScript, å¾ªç¯, æ¡ä»¶åˆ¤æ–­" />
          </div>
          <div class="input-group">
            <label>
              <input type="checkbox" id="repo-public" checked />
              å…è®¸åœ¨æœ¬æœºæ‰€æœ‰è¯¾ç¨‹ä¸­å¤ç”¨ï¼ˆæœ¬åœ°ä»£ç åº“ï¼‰
            </label>
          </div>
          <div id="code-repo-status" class="success-message" style="display: none;"></div>
          <div class="ai-actions">
            <button type="submit" class="primary">
              <span class="btn-text">ä¿å­˜æ¡ˆä¾‹</span>
            </button>
            <button type="button" id="cancel-code-repo" class="secondary">å–æ¶ˆ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ä½¿ç”¨æœ¬åœ°CodeMirrorèµ„æº -->
  <script src="lib/codemirror/codemirror.min.js"></script>
  <script src="lib/codemirror/xml.min.js"></script>
  <script src="lib/codemirror/css.min.js"></script>
  <script src="lib/codemirror/javascript.min.js"></script>
  <script src="lib/codemirror/closetag.min.js"></script>
  <script src="lib/codemirror/closebrackets.min.js"></script>
  <script src="lib/codemirror/matchbrackets.min.js"></script>
  <script type="module" src="js/languageManager.js"></script>
  <script type="module" src="js/main.js?v=20251116-52"></script>

  <!-- è°ƒè¯•è„šæœ¬ (ä»…åœ¨å¼€å‘æ—¶ä½¿ç”¨) -->
  <script>
    // é¡µé¢åŠ è½½æ—¶æ¸…ç†é‡å¤çš„æŒ‰é’®
    document.addEventListener('DOMContentLoaded', function() {
      // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ¸…ç†
      cleanupDuplicateButtons();

      // ç„¶åæ¯éš”ä¸€æ®µæ—¶é—´æ¸…ç†ï¼Œé˜²æ­¢åŠ¨æ€æŒ‰é’®é‡æ–°å‡ºç°
      setInterval(cleanupDuplicateButtons, 1000);

      // æœ€ååœ¨é¡µé¢å®Œå…¨åŠ è½½åå†æ¸…ç†ä¸€æ¬¡
      setTimeout(cleanupDuplicateButtons, 1000);
      setTimeout(cleanupDuplicateButtons, 3000);

      // ç‰¹åˆ«é’ˆå¯¹ä½œä¸šæ¨¡å¼çš„æŒ‰é’®æ£€æŸ¥
      setTimeout(forceShowAssignmentButtons, 500);
      setTimeout(forceShowAssignmentButtons, 2000);
    });

    let lastCodeRepoCaseState = null;

    // å¼ºåˆ¶æ˜¾ç¤ºä½œä¸šæŒ‰é’®çš„å‡½æ•°
    function forceShowAssignmentButtons() {
      // æ£€æµ‹æ˜¯å¦ä¸ºä½œä¸šæ¨¡å¼
      const urlParams = new URLSearchParams(window.location.search);
      const assignmentId = urlParams.get('assignment');
      const studentId = urlParams.get('student');
      const mode = urlParams.get('mode');
      const isAssignmentMode = !!(assignmentId || studentId || mode);

      // å¦‚æœæ˜¯ä½œä¸šæ¨¡å¼ï¼Œå¼ºåˆ¶æ˜¾ç¤ºæŒ‰é’®
      if (isAssignmentMode) {
        const backBtn = document.getElementById('assignment-back-btn');
        const submitBtn = document.getElementById('assignment-submit-btn');

        if (backBtn) {
          backBtn.style.display = 'inline-block';
          backBtn.style.visibility = 'visible';
          backBtn.style.opacity = '1';
        }
        if (submitBtn) {
          submitBtn.style.display = 'inline-block';
          submitBtn.style.visibility = 'visible';
          submitBtn.style.opacity = '1';
        }

        console.log('ğŸ”§ å¼ºåˆ¶æ˜¾ç¤ºä½œä¸šæŒ‰é’®', {
          assignmentId,
          studentId,
          mode,
          backBtn: !!backBtn,
          submitBtn: !!submitBtn
        });
      }
    }

    function cleanupDuplicateButtons() {
      // æŸ¥æ‰¾å¹¶ç§»é™¤æ‰€æœ‰åŠ¨æ€åˆ›å»ºçš„assignment-nav-btnæŒ‰é’®
      const dynamicButtons = document.querySelectorAll('.assignment-nav-btn');
      dynamicButtons.forEach(btn => {
        console.log('ç§»é™¤é‡å¤æŒ‰é’®:', btn.textContent.trim());
        btn.remove();
      });

      // ç¡®ä¿åªä¿ç•™æˆ‘ä»¬éœ€è¦çš„æŒ‰é’®
      const keepBackBtn = document.getElementById('assignment-back-btn');
      const keepSubmitBtn = document.getElementById('assignment-submit-btn');

      // æ£€æµ‹æ˜¯å¦ä¸ºä½œä¸šæ¨¡å¼
      const urlParams = new URLSearchParams(window.location.search);
      const assignmentId = urlParams.get('assignment');
      const studentId = urlParams.get('student');
      const mode = urlParams.get('mode');
      const isAssignmentMode = !!(assignmentId || studentId || mode);

      // å¦‚æœæ£€æµ‹åˆ°ä»£ç åº“æ¡ˆä¾‹ï¼Œéšè—ä½œä¸šæŒ‰é’®
      const hasCodeRepoCase = localStorage.getItem('oj-current-repo-open');
      const currentRepoState = !!hasCodeRepoCase;

      // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
      const currentUser = JSON.parse(sessionStorage.getItem('current-user') || localStorage.getItem('oj-current-user') || '{}');
      const isTeacher = currentUser.role === 'teacher' || currentUser.role === 'admin';

      // æ§åˆ¶æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
      let showBackButton = false;
      let showSubmitButton = false;

      // è¿”å›æŒ‰é’®ï¼šè€å¸ˆåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½å¯ä»¥çœ‹åˆ°ï¼Œå­¦ç”Ÿåªåœ¨ä½œä¸šæ¨¡å¼æ—¶çœ‹åˆ°
      if (isTeacher) {
        showBackButton = true;
      } else if (isAssignmentMode && !currentRepoState) {
        showBackButton = true;
      }

      // æäº¤æŒ‰é’®ï¼šåªåœ¨ä½œä¸šæ¨¡å¼ä¸‹ä¸”ä¸æ˜¯ä»£ç åº“æ¨¡å¼æ—¶æ˜¾ç¤º
      if (isAssignmentMode && !currentRepoState) {
        showSubmitButton = true;
      }

      // æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
      if (showBackButton) {
        if (keepBackBtn) keepBackBtn.style.display = 'inline-block';
      } else {
        if (keepBackBtn) keepBackBtn.style.display = 'none';
      }

      if (showSubmitButton) {
        if (keepSubmitBtn) keepSubmitBtn.style.display = 'inline-block';
      } else {
        if (keepSubmitBtn) keepSubmitBtn.style.display = 'none';
      }

      // è°ƒè¯•æ—¥å¿—
      console.log('ğŸ›ï¸ æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€:', {
        isTeacher,
        isAssignmentMode,
        currentRepoState,
        showBackButton,
        showSubmitButton,
        userRole: currentUser.role
      });

      lastCodeRepoCaseState = currentRepoState;
    }

    // æä¾›å…¨å±€çš„ä½œä¸šå¯¼èˆªå‡½æ•°
    window.goBackToAssignment = async function() {
      console.log('ğŸ”™ è¿”å›æŒ‰é’®è¢«ç‚¹å‡»');

      try {
        // æ–¹æ¡ˆ1ï¼šä» sessionStorage è·å–ç”¨æˆ·ä¿¡æ¯
        let user = null;
        const sessionUser = sessionStorage.getItem('current-user');

        if (sessionUser) {
          user = JSON.parse(sessionUser);
          console.log('âœ… ä» sessionStorage è·å–åˆ°ç”¨æˆ·ä¿¡æ¯:', user.fullName);
        } else {
          // æ–¹æ¡ˆ2ï¼šä» URL å‚æ•°è·å–ç”¨æˆ·ä¿¡æ¯
          const urlParams = new URLSearchParams(window.location.search);
          const userId = urlParams.get('userId');
          const userName = urlParams.get('userName');
          const userRole = urlParams.get('userRole');

          if (userId && userName && userRole) {
            user = {
              id: userId,
              username: userName,
              role: userRole,
              fullName: urlParams.get('fullName') || userName
            };
            // ä¿å­˜åˆ° sessionStorage
            sessionStorage.setItem('current-user', JSON.stringify(user));
            console.log('âœ… ä» URL å‚æ•°é‡å»ºç”¨æˆ·ä¿¡æ¯:', user.fullName);
          }
        }

        if (!user) {
          console.log('âš ï¸ æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
          window.location.href = 'login.html';
          return;
        }

        // å¸¦ç€ç”¨æˆ·ä¿¡æ¯è·³è½¬åˆ° main.htmlï¼Œé¿å…é‡å¤è®¤è¯
        const userParams = `?userId=${user.id}&userName=${user.username}&userRole=${user.role}&fullName=${encodeURIComponent(user.fullName)}`;
        console.log('âœ… è¿”å›åˆ°ä»ªè¡¨ç›˜ï¼Œæºå¸¦ç”¨æˆ·å‚æ•°');
        window.location.href = `main.html${userParams}`;
      } catch (error) {
        console.error('âŒ å¤„ç†è¿”å›æ—¶å‘ç”Ÿé”™è¯¯:', error);
        window.location.href = 'login.html';
      }
    };

    window.submitAssignment = function() {
      console.log('ğŸ“¤ æäº¤æŒ‰é’®è¢«ç‚¹å‡»');

      try {
        // æ£€æŸ¥fileManageræ˜¯å¦å­˜åœ¨
        if (!window.fileManager) {
          console.error('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–å®Œæˆï¼Œè¯·ç¨åå†è¯•');
          return;
        }

        // æ”¶é›†å½“å‰ç¼–è¾‘å™¨ä¸­çš„æ–‡ä»¶
        const files = {};

        try {
          // å°è¯•ä½¿ç”¨Mapæ–¹å¼éå†
          if (typeof window.fileManager.files.forEach === 'function') {
            window.fileManager.files.forEach((fileData, fileName) => {
              files[fileName] = fileData.content;
            });
          }
          // å¦‚æœæ˜¯æ™®é€šå¯¹è±¡ï¼Œä½¿ç”¨Object.entrieséå†
          else if (window.fileManager.files && typeof window.fileManager.files === 'object') {
            Object.entries(window.fileManager.files).forEach(([fileName, fileData]) => {
              if (fileData && typeof fileData.content === 'string') {
                files[fileName] = fileData.content;
              }
            });
          }
        } catch (error) {
          console.error('æ”¶é›†æ–‡ä»¶æ—¶å‡ºé”™:', error);
          // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä»ç¼–è¾‘å™¨è·å–å†…å®¹
          if (window.editors && window.editors.html) {
            files['html/index.html'] = window.editors.html.getValue();
          }
          if (window.editors && window.editors.css) {
            files['css/style.css'] = window.editors.css.getValue();
          }
          if (window.editors && window.editors.js) {
            files['js/main.js'] = window.editors.js.getValue();
          }
        }

        console.log('æ”¶é›†åˆ°çš„æ–‡ä»¶:', Object.keys(files));

        // è·å–å½“å‰ç”¨æˆ·å’Œä½œä¸šä¿¡æ¯
        const currentUser = JSON.parse(sessionStorage.getItem('current-user') || localStorage.getItem('oj-current-user') || '{}');
        const urlParams = new URLSearchParams(window.location.search);
        const assignmentId = urlParams.get('assignment') || 'demo-assignment';

        console.log('ğŸ“¤ æäº¤ä½œä¸šè°ƒè¯•ä¿¡æ¯:', {
          assignmentId,
          currentUser,
          urlAssignmentId: urlParams.get('assignment')
        });

        // åˆ›å»ºæäº¤æ•°æ®
        const submission = {
          id: `sub_${Date.now()}`,
          assignmentId: assignmentId === 'demo-assignment' ? '111' : assignmentId, // å¦‚æœæ˜¯é»˜è®¤å€¼ï¼Œä½¿ç”¨111ä½œä¸šçš„ID
          studentId: currentUser.id || currentUser.username,
          studentName: currentUser.fullName || currentUser.username,
          submittedAt: new Date().toISOString(),
          files: files,
          status: 'submitted'
        };

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ä»½
        const existingSubmissions = JSON.parse(localStorage.getItem('oj-assignment-submissions') || '[]');
        existingSubmissions.push(submission);
        localStorage.setItem('oj-assignment-submissions', JSON.stringify(existingSubmissions));

        console.log('ä½œä¸šæäº¤æˆåŠŸ:', submission);

        // æ˜¾ç¤ºä¸€ä¸ªå°çš„æˆåŠŸæç¤ºï¼Œç„¶åè‡ªåŠ¨è¿”å›
        showSuccessNotification('ä½œä¸šæäº¤æˆåŠŸï¼è€å¸ˆå¯ä»¥æŸ¥çœ‹å’Œæ‰¹æ”¹ä½ çš„ä½œä¸šäº†ã€‚');

        // å»¶è¿Ÿ1ç§’åè‡ªåŠ¨è¿”å›åˆ°ä½œä¸šåˆ—è¡¨é¡µé¢
        setTimeout(() => {
          window.goBackToAssignment();
        }, 1000);

      } catch (error) {
        console.error('æäº¤å¤±è´¥:', error);
        showSuccessNotification('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    };

    // æ˜¾ç¤ºæˆåŠŸæç¤ºçš„å‡½æ•°
    function showSuccessNotification(message) {
      // åˆ›å»ºæç¤ºå…ƒç´ 
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
      `;
      notification.textContent = message;

      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(notification);

      // æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
      }, 100);

      // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // ç­‰å¾…ä¸»åº”ç”¨åŠ è½½å®Œæˆåæ‰§è¡Œè°ƒè¯•
    setTimeout(() => {
      console.log('ğŸ”§ åŠ è½½è°ƒè¯•è„šæœ¬...');

      // æ£€æŸ¥åº”ç”¨æ˜¯å¦æ­£å¸¸åˆå§‹åŒ–
      if (window.fileManager && window.fileOperations && window.editors) {
        console.log('âœ… ä¸»åº”ç”¨åˆå§‹åŒ–æ­£å¸¸');

        // æ·»åŠ å…¨å±€æµ‹è¯•å‡½æ•°
        window.testImageImport = function() {
          console.log('ğŸ§ª æ‰‹åŠ¨æµ‹è¯•å›¾ç‰‡å¯¼å…¥');
          const fileInput = document.getElementById('file-input');
          if (fileInput) {
            fileInput.click();
          } else {
            console.error('âŒ æ‰¾ä¸åˆ°æ–‡ä»¶è¾“å…¥å…ƒç´ ');
          }
        };

        console.log('ğŸ”§ ä½œä¸šå¯¼èˆªæŒ‰é’®å·²å°±ç»ªï¼ŒåŠŸèƒ½åŒ…æ‹¬:');
        console.log('- è¿”å›æŒ‰é’®: goBackToAssignment()');
        console.log('- æäº¤æŒ‰é’®: submitAssignment()');
        console.log('- testImageImport() - æµ‹è¯•å›¾ç‰‡å¯¼å…¥');

        // ç«‹å³æ›´æ–°æŒ‰é’®çŠ¶æ€
        cleanupDuplicateButtons();

        // æ·»åŠ æµ‹è¯•å‡½æ•°
        window.testSubmission = function() {
          console.log('ğŸ§ª æµ‹è¯•å­¦ç”Ÿæäº¤...');
          const currentUser = JSON.parse(sessionStorage.getItem('current-user') || localStorage.getItem('oj-current-user') || '{}');
          const testSubmission = {
            id: `test_${Date.now()}`,
            assignmentId: '111', // ç¡¬ç¼–ç ä¸º111ä½œä¸šçš„ID
            studentId: currentUser.id || currentUser.username || 'test_student',
            studentName: currentUser.fullName || currentUser.username || 'æµ‹è¯•å­¦ç”Ÿ',
            submittedAt: new Date().toISOString(),
            files: {
              'html/index.html': '<h1>æµ‹è¯•ä½œä¸š</h1>',
              'css/style.css': 'body { color: red; }'
            },
            status: 'submitted'
          };

          const existingSubmissions = JSON.parse(localStorage.getItem('oj-assignment-submissions') || '[]');
          existingSubmissions.push(testSubmission);
          localStorage.setItem('oj-assignment-submissions', JSON.stringify(existingSubmissions));

          console.log('âœ… æµ‹è¯•æäº¤å®Œæˆ:', testSubmission);
          alert('æµ‹è¯•æäº¤å·²åˆ›å»ºï¼Œè¯·åˆ·æ–°æ•™å¸ˆç«¯é¡µé¢æŸ¥çœ‹');
        };
      } else {
        console.warn('âš ï¸ ä¸»åº”ç”¨åˆå§‹åŒ–å¯èƒ½å­˜åœ¨é—®é¢˜');
        console.log('- fileManager:', !!window.fileManager);
        console.log('- fileOperations:', !!window.fileOperations);
        console.log('- editors:', !!window.editors);
      }
    }, 2000);
  </script>

    <!-- å¤‡ç”¨ä»£ç åº“åŠŸèƒ½è„šæœ¬ -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        console.log('å¤‡ç”¨ä»£ç åº“è„šæœ¬åŠ è½½...');

        // ç¡®ä¿æ¨¡æ€æ¡†æ˜¾ç¤ºåŠŸèƒ½å¯ç”¨
        function showCodeRepoModal() {
          console.log('å¤‡ç”¨showCodeRepoModalè¢«è°ƒç”¨...');
          const modal = document.getElementById('code-repo-modal');
          if (modal) {
            modal.style.display = 'flex';
            console.log('æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
          } else {
            console.error('æ‰¾ä¸åˆ°æ¨¡æ€æ¡†å…ƒç´ ');
          }
        }

        // ç¡®ä¿æ¨¡æ€æ¡†æ˜¾ç¤ºåŠŸèƒ½å¯ç”¨
        function showCodeRepoModal() {
          console.log('å¤‡ç”¨showCodeRepoModalè¢«è°ƒç”¨...');
          const modal = document.getElementById('code-repo-modal');
          if (modal) {
            modal.style.display = 'flex';
            console.log('æ¨¡æ€æ¡†å·²æ˜¾ç¤º');

            // è®¾ç½®é»˜è®¤æ ‡é¢˜
            const titleInput = document.getElementById('repo-title');
            if (titleInput && !titleInput.value.trim()) {
              titleInput.value = 'æœªå‘½åæ¡ˆä¾‹';
            }
          } else {
            console.error('æ‰¾ä¸åˆ°æ¨¡æ€æ¡†å…ƒç´ ');
          }
        }

        function hideCodeRepoModal() {
          console.log('hideCodeRepoModalè¢«è°ƒç”¨...');
          const modal = document.getElementById('code-repo-modal');
          if (modal) {
            modal.style.display = 'none';
          }
        }

        function handleCodeRepoSave() {
          console.log('handleCodeRepoSaveè¢«è°ƒç”¨...');

          const titleInput = document.getElementById('repo-title');
          const descInput = document.getElementById('repo-description');
          const status = document.getElementById('code-repo-status');

          const title = titleInput ? titleInput.value.trim() : '';
          if (!title) {
            alert('è¯·è¾“å…¥æ¡ˆä¾‹æ ‡é¢˜');
            return;
          }

          const description = descInput ? descInput.value.trim() : '';

          // æ”¶é›†å½“å‰æ–‡ä»¶ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
          const files = [];
          if (window.fileManager && window.fileManager.files) {
            try {
              window.fileManager.files.forEach((fileData, fileName) => {
                if (fileData && typeof fileData.content === 'string') {
                  const content = fileData.content.trim();
                  if (content) {
                    const type = fileName.endsWith('.html') ? 'html' :
                                 fileName.endsWith('.css') ? 'css' :
                                 fileName.endsWith('.js') ? 'javascript' : 'text';
                    files.push({ name: fileName, content, type });
                  }
                }
              });
            } catch (error) {
              console.error('æ”¶é›†æ–‡ä»¶å¤±è´¥:', error);
            }
          }

          if (files.length === 0) {
            alert('å½“å‰æ²¡æœ‰å¯ä¿å­˜çš„ä»£ç æ–‡ä»¶');
            return;
          }

          // åˆ›å»ºä»£ç åº“é¡¹ç›®
          const repoItem = {
            id: `repo_${Date.now()}`,
            title,
            description,
            author: 'æœ¬åœ°ç”¨æˆ·',
            createdAt: new Date().toISOString(),
            files
          };

          try {
            const list = JSON.parse(localStorage.getItem('oj-code-repository') || '[]');
            list.unshift(repoItem);
            localStorage.setItem('oj-code-repository', JSON.stringify(list));

            console.log('âœ… æ¡ˆä¾‹å·²ä¿å­˜åˆ°æœ¬åœ°ä»£ç åº“:', repoItem);
            alert('æ¡ˆä¾‹å·²ä¿å­˜åˆ°æœ¬åœ°ä»£ç åº“');

            hideCodeRepoModal();
          } catch (error) {
            console.error('ä¿å­˜å¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
          }
        }

        // å°†å¤‡ç”¨å‡½æ•°æš´éœ²åˆ°å…¨å±€
        window.showCodeRepoModal = showCodeRepoModal;
        window.hideCodeRepoModal = hideCodeRepoModal;
        window.handleCodeRepoSave = handleCodeRepoSave;

        // è®¾ç½®æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
        setTimeout(() => {
          const closeBtn = document.getElementById('close-code-repo');
          const cancelBtn = document.getElementById('cancel-code-repo');
          const form = document.getElementById('code-repo-form');
          const modal = document.getElementById('code-repo-modal');

          if (closeBtn) {
            closeBtn.addEventListener('click', hideCodeRepoModal);
          }
          if (cancelBtn) {
            cancelBtn.addEventListener('click', hideCodeRepoModal);
          }
          if (form) {
            form.addEventListener('submit', function(e) {
              e.preventDefault();
              handleCodeRepoSave();
            });
          }
          if (modal) {
            modal.addEventListener('click', function(e) {
              if (e.target === modal) {
                hideCodeRepoModal();
              }
            });
          }

          // åˆ é™¤äº†ä¿å­˜åˆ°ä»£ç åº“æŒ‰é’®çš„ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
        }, 1000);
      });
    </script>
</body>
</html>
